<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Phonics & Tracing Fun</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Comic+Neue:wght@700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Comic Neue', cursive;
        }
        .letter-display {
            font-size: 10rem;
            line-height: 1;
        }
        .nav-button {
            transition: transform 0.1s ease-in-out;
        }
        .nav-button:active {
            transform: scale(0.9);
        }
        .exercise-card {
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .exercise-card:hover {
            transform: translateY(-5px) scale(1.02);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
        }
        .selected {
            border-color: #3b82f6; /* blue-500 */
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.4);
        }
        .correct {
            border-color: #22c55e; /* green-500 */
            box-shadow: 0 0 0 4px rgba(34, 197, 94, 0.4);
            animation: bounce 0.5s;
        }
        .incorrect {
            border-color: #ef4444; /* red-500 */
            box-shadow: 0 0 0 4px rgba(239, 68, 68, 0.4);
            animation: shake 0.5s;
        }
        @keyframes bounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-10px); }
        }
        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            25% { transform: translateX(-5px); }
            75% { transform: translateX(5px); }
        }
        @keyframes flash {
            0%, 100% { box-shadow: 0 0 0 0 rgba(249, 115, 22, 0.7); } /* orange-500 */
            50% { box-shadow: 0 0 20px 10px rgba(249, 115, 22, 0); }
        }
        .tab-button.active {
            background-color: #f97316; /* orange-500 */
            color: white;
        }
        .letter-hunt-board {
            position: relative;
            perspective: 1000px;
            contain: layout style; /* Optimization: tell browser this element's content doesn't affect outside layout */
        }
        .letter-hunt-item {
            position: absolute;
            cursor: pointer;
            transition: transform 0.3s ease, opacity 0.3s ease;
            user-select: none;
        }

        .letter-hunt-item:hover {
            transform: scale(1.1);
        }
        .letter-hunt-item.found {
            transform: scale(0.8);
            opacity: 0;
        }
        .activity-view {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background-color: white;
            padding: 1rem; /* p-4 */
        }
    </style>
</head>
<body class="bg-blue-50 text-gray-800 flex items-center justify-center min-h-screen p-4">

    <div id="app-container" class="w-full max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl p-4 sm:p-8">
        <header class="text-center mb-6">
            <h1 class="text-4xl sm:text-5xl font-bold text-orange-600">Phonics & Tracing Fun!</h1>
            <p class="text-gray-500 text-lg">Learn the letter 'A' sound and practice writing.</p>
        </header>

        <!-- Main Menu -->
        <div id="main-menu" class="flex flex-col items-center justify-center gap-4">
            <a href="learn.html" class="text-center menu-button w-full max-w-sm text-xl sm:text-2xl bg-green-500 hover:bg-green-600 text-white font-bold py-3 sm:py-4 px-6 rounded-2xl shadow-lg">Learn the Letter</a>
            <a href="trace.html" class="text-center menu-button w-full max-w-sm text-xl sm:text-2xl bg-green-500 hover:bg-green-600 text-white font-bold py-3 sm:py-4 px-6 rounded-2xl shadow-lg">Letter Tracing</a>
            <button data-view="practice" class="menu-button w-full max-w-sm text-xl sm:text-2xl bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 sm:py-4 px-6 rounded-2xl shadow-lg">Practice Games</button>
            <button data-view="hunt" class="menu-button w-full max-w-sm text-xl sm:text-2xl bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 sm:py-4 px-6 rounded-2xl shadow-lg">Letter Hunt</button>
        </div>

        <main id="main-content">
            <!-- Practice Games View -->
            <div id="practice-view" class="activity-view hidden">
                 <button class="back-button absolute top-4 left-4 nav-button bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-full">&larr; Menu</button>
                 <div id="game-selection" class="flex justify-center gap-4 mb-6">
                    <!-- Game selection buttons will be inserted here -->
                </div>
                <div id="exercise-container" class="text-center">
                    <h2 id="exercise-title" class="text-3xl font-bold text-yellow-600 mb-2"></h2>
                    <div id="exercise-image" class="text-8xl my-6 flex justify-center items-center h-40"></div>
                    <div id="exercise-options" class="grid grid-cols-2 sm:grid-cols-4 gap-4 max-w-xl mx-auto">
                        <!-- Options go here -->
                    </div>
                    <button id="next-exercise-button" class="nav-button mt-8 bg-yellow-500 hover:bg-yellow-600 text-white font-bold py-3 px-8 rounded-full shadow-lg text-xl hidden">Next Question</button>
                </div>
            </div>

            <!-- Letter Hunt View -->
            <div id="hunt-view" class="activity-view hidden">
                <button class="back-button absolute top-4 left-4 nav-button bg-gray-200 hover:bg-gray-300 text-gray-700 font-bold py-2 px-4 rounded-full">&larr; Menu</button>
                <div class="text-center">
                    <h2 class="text-3xl font-bold text-blue-600 mb-4">Letter Hunt!</h2>
                    <div id="hunt-mode-selection" class="flex justify-center gap-4 mb-6">
                        <button id="find-capitals-btn" class="nav-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full">Find the Capital Letters</button>
                        <button id="find-lowers-btn" class="nav-button bg-blue-500 hover:bg-blue-600 text-white font-bold py-3 px-6 rounded-full">Find the Lower Case Letters</button>
                    </div>
                    <div id="hunt-board" class="letter-hunt-board p-4 bg-blue-50 rounded-2xl min-h-[300px] flex items-center justify-center">
                        <p class="text-gray-500 text-xl">Select a mode to start the game!</p>
                    </div>
                    <div id="hunt-complete-message" class="hidden mt-6"></div>
                </div>
            </div>
        </main>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const letterData = {
                letter: 'a',
                sound: 'ah',
                audioSrc: 'YOUR_LINK_HERE',
                examples: [ // Belizean Context Examples
                    { emoji: 'ðŸœ', name: 'ant',        startsWith: 'a' },
                    { emoji: 'ðŸŠ', name: 'alligator',  startsWith: 'a' },
                    { emoji: 'ðŸ¹', name: 'arrow',      startsWith: 'a' },
                    { emoji: 'ðŸ’ª', name: 'arm',        startsWith: 'a' },
                    { emoji: 'ðŸ¾', name: 'armadillo',  startsWith: 'a' }, // Using a paw print as a proxy
                    { emoji: 'ðŸ›‹ï¸', name: 'armchair',   startsWith: 'a' },
                ],
            };

            const synth = window.speechSynthesis;
            let audioCtx; // For Web Audio API
            
            // Practice elements
            const gameSelection = document.getElementById('game-selection');
            const exerciseTitle = document.getElementById('exercise-title');
            const exerciseImage = document.getElementById('exercise-image');
            const exerciseOptions = document.getElementById('exercise-options');
            const nextExerciseButton = document.getElementById('next-exercise-button');
            let findLetterCorrectCount = 0; // Counter for the 'find-letter' game
            const celebrationThreshold = { 'sound-match': 3, 'find-letter': 5 }; // How many correct answers to trigger celebration

            // Views
            const mainMenu = document.getElementById('main-menu');
            const practiceView = document.getElementById('practice-view');
            const huntView = document.getElementById('hunt-view'); 
            let activeGame = 'sound-match';

            // Letter Hunt elements
            const huntBoard = document.getElementById('hunt-board');
            const findCapitalsBtn = document.getElementById('find-capitals-btn');
            const findLowersBtn = document.getElementById('find-lowers-btn');
            const huntCompleteMessage = document.getElementById('hunt-complete-message');
            let huntMode = null; // 'capital' or 'lower'

            // State for the sound-match game
            const soundMatchGoal = 5; // How many correct matches to win
            let soundMatchCorrectCount = 0;
            let targetCount = 0;

            function initialize() {
                setupGameSelection();
                setupEventListeners();
                findLetterCorrectCount = 0; // Reset counter on init
                showView('menu');
            }
            
            function setupEventListeners() {
                nextExerciseButton.addEventListener('click', () => generateExercise(activeGame));
                exerciseOptions.addEventListener('click', handlePracticeClick);
                
                mainMenu.addEventListener('click', (e) => {
                    const button = e.target.closest('.menu-button');
                    if (button) {
                        const viewName = button.dataset.view;
                        showView(viewName);
                    }
                });

                document.querySelectorAll('.back-button').forEach(button => {
                    button.addEventListener('click', () => showView('menu'));
                });

                findCapitalsBtn.addEventListener('click', () => startHuntGame('capital'));
                findLowersBtn.addEventListener('click', () => startHuntGame('lower'));
            }

            function showView(viewName) {
                mainMenu.classList.toggle('hidden', viewName !== 'menu');
                practiceView.classList.toggle('hidden', viewName !== 'practice');
                huntView.classList.toggle('hidden', viewName !== 'hunt');

                // Initialize game when view is shown
                if (viewName === 'practice') {
                    findLetterCorrectCount = 0; // Reset counter when switching to practice tab
                    generateExercise(activeGame);
                } else if (viewName === 'hunt') {
                    resetHuntGame();
                }
            }

            function setupGameSelection() {
                const games = [
                    { id: 'sound-match', name: 'Match the Sound' },
                    { id: 'find-letter', name: 'Capital or Lowercase?' }
                ];
                gameSelection.innerHTML = '';
                games.forEach(game => {
                    const button = document.createElement('button');
                    button.textContent = game.name;
                    button.className = 'game-select-button nav-button bg-yellow-200 text-yellow-800 font-bold py-2 px-4 rounded-full';
                    button.dataset.game = game.id;
                    button.addEventListener('click', (e) => {
                        activeGame = game.id;
                        generateExercise(activeGame);
                    });
                    gameSelection.appendChild(button);
                });
            }

            function playAudioFile(url, volume = 1) {
                if (!url || url === 'YOUR_LINK_HERE' || url === 'YOUR_TEACHER_AUDIO_LINK_HERE') {
                    console.warn('Audio URL is a placeholder or missing. Provide a valid link to play the sound.');
                    // As a fallback, we can use the synth voice to notify the user.
                    playSound('Teacher audio has not been set up yet.', volume);
                    return;
                }
                const audio = new Audio(url);
                audio.volume = volume;
                audio.play().catch(e => {
                    console.error("Error playing audio file:", e, "Falling back to synth.");
                    // Fallback to synth if the audio file fails to play
                    playSound(letterData.sound, volume);
                });
            }

            function playSound(soundText, volume = 1, rate = 0.8) { // Default rate is now 0.8
                if (synth.speaking) {
                    synth.cancel();
                }
                const utterance = new SpeechSynthesisUtterance(soundText);
                utterance.lang = 'en-US';
                utterance.volume = volume;
                utterance.rate = rate;
                // Try to find a good voice
                const voices = synth.getVoices();
                const englishVoice = voices.find(voice => voice.lang.startsWith('en') && voice.name.includes('Google'));
                if(englishVoice) utterance.voice = englishVoice;
                
                synth.speak(utterance);
            }

            function playTone(frequency = 440, duration = 100, type = 'sine') {
                if (!audioCtx) {
                    try {
                        audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                    } catch (e) {
                        console.error("Web Audio API is not supported in this browser");
                        return;
                    }
                }
                const oscillator = audioCtx.createOscillator();
                oscillator.type = type;
                oscillator.frequency.setValueAtTime(frequency, audioCtx.currentTime);
                oscillator.connect(audioCtx.destination);
                oscillator.start();
                setTimeout(() => oscillator.stop(), duration);
            }
            
            // Practice Game Functions
            function generateExercise(gameType) {
                nextExerciseButton.classList.add('hidden');
                exerciseOptions.innerHTML = '';

                // Update active game button style
                document.querySelectorAll('.game-select-button').forEach(btn => {
                    const isActive = btn.dataset.game === gameType;
                    btn.classList.toggle('bg-yellow-500', isActive);
                    if(btn.dataset.game === gameType) findLetterCorrectCount = 0; // Reset counter when switching game
                    btn.classList.toggle('text-white', btn.dataset.game === gameType);
                    btn.classList.toggle('bg-yellow-200', btn.dataset.game !== gameType);
                    btn.classList.toggle('text-yellow-800', btn.dataset.game !== gameType);
                });

                if (gameType === 'sound-match') {
                    generateSoundMatchExercise();
                } else if (gameType === 'find-letter') {
                    generateFindLetterExercise();
                }

                // Reset counter if the game type changes
                if (gameType !== activeGame) {
                    correctInARow = 0;
                    generateFindLetterExercise();
                }

                if (gameType === 'sound-match') {
                    soundMatchCorrectCount = 0;
                    generateSingleSoundMatch();
                } else if (gameType === 'find-letter') {
                    findLetterCorrectCount = 0;
                    generateFindLetterExercise();
                }
            }

            function generateSoundMatchExercise() {
                exerciseTitle.textContent = "What sound does this start with?";
                const correctAnswer = letterData;
                const randomExample = correctAnswer.examples[Math.floor(Math.random() * correctAnswer.examples.length)];
                exerciseImage.textContent = randomExample.emoji;

                // For this game, we need other letters. Let's create some dummy ones.
                const otherLetters = [{ letter: 'b', sound: 'b' }, { letter: 'm', sound: 'm' }, { letter: 's', sound: 's' }, { letter: 't', sound: 't' }, { letter: 'p', sound: 'p' }];
                let options = [correctAnswer];
                while (options.length < 4) {
                    const randomLetter = otherLetters[Math.floor(Math.random() * otherLetters.length)];
                    if (!options.some(opt => opt.letter === randomLetter.letter)) options.push(randomLetter);
                }
                options.sort(() => Math.random() - 0.5); // Shuffle

                exerciseOptions.innerHTML = '';
                options.forEach(option => {
                    const card = document.createElement('div');
                    card.className = 'exercise-card bg-gray-100 p-4 rounded-2xl border-4 border-gray-200 flex items-center justify-center';
                    card.innerHTML = `<span class="text-6xl font-bold text-gray-700">${option.letter}</span>`;
                    card.dataset.correctLetter = correctAnswer.letter;
                    card.dataset.letter = option.letter; // The letter this card represents
                    card.dataset.exampleName = randomExample.name;
                    exerciseOptions.appendChild(card);
                });
            }

            function generateSingleSoundMatch() {
                exerciseTitle.textContent = `Match ${soundMatchCorrectCount} of ${soundMatchGoal}`;
                const correctAnswer = letterData;
                const randomExample = correctAnswer.examples[Math.floor(Math.random() * correctAnswer.examples.length)];
                exerciseImage.textContent = randomExample.emoji;

                // For this game, we need other letters. Let's create some dummy ones.
                const otherLetters = [{ letter: 'b', sound: 'b' }, { letter: 'm', sound: 'm' }, { letter: 's', sound: 's' }, { letter: 't', sound: 't' }, { letter: 'p', sound: 'p' }];
                let options = [correctAnswer];
                while (options.length < 4) {
                    const randomLetter = otherLetters[Math.floor(Math.random() * otherLetters.length)];
                    if (!options.some(opt => opt.letter === randomLetter.letter)) options.push(randomLetter);
                }
                options.sort(() => Math.random() - 0.5); // Shuffle

                exerciseOptions.innerHTML = '';
                options.forEach(option => {
                    const card = document.createElement('div');
                    card.className = 'exercise-card bg-gray-100 p-4 rounded-2xl border-4 border-gray-200 flex items-center justify-center';
                    card.innerHTML = `<span class="text-6xl font-bold text-gray-700">${option.letter}</span>`;
                    card.dataset.correctLetter = correctAnswer.letter;
                    card.dataset.letter = option.letter; // The letter this card represents
                    card.dataset.exampleName = randomExample.name;
                    exerciseOptions.appendChild(card);
                });
            }

            function generateFindLetterExercise() {
                exerciseTitle.textContent = `Find ${findLetterCorrectCount} of 5`;
                const isFindingCapital = Math.random() > 0.5;
                const instructionText = isFindingCapital ? `Click on the capital ${letterData.sound}` : `Click on the lowercase ${letterData.sound}`;
                const titleText = isFindingCapital ? "Click on the capital A" : "Click on the lowercase a";
                const targetLetter = isFindingCapital ? 'A' : 'a';
                
                exerciseTitle.textContent = titleText;
                playSound(instructionText, 1); // Uses the new default slower rate
                exerciseImage.innerHTML = ''; // Clear the emoji image
                
                // Use the options container as the game board
                exerciseOptions.className = 'grid grid-cols-2 gap-4 max-w-xl mx-auto';
                exerciseOptions.innerHTML = ''; // Clear previous options

                const options = ['A', 'a'].sort(() => Math.random() - 0.5); // Shuffle them
                const colors = ['text-blue-500', 'text-green-500', 'text-purple-500', 'text-orange-500', 'text-pink-500'];

                options.forEach((letter, index) => {
                    const card = document.createElement('div');
                    card.className = 'exercise-card bg-yellow-50 p-4 rounded-2xl border-8 border-yellow-100 flex items-center justify-center h-48';
                    
                    const colorClass = colors[index % colors.length];
                    card.innerHTML = `<span class="text-9xl font-bold ${colorClass}">${letter}</span>`;
                    card.dataset.correctLetter = targetLetter;
                    card.dataset.letter = letter;
                    exerciseOptions.appendChild(card);
                });
            }

            function handlePracticeClick(e) {
                const selectedCard = e.target.closest('.exercise-card');
                if (!selectedCard) return;

                const selectedLetter = selectedCard.dataset.letter;
                const correctLetter = selectedCard.dataset.correctLetter;
                const exampleName = selectedCard.dataset.exampleName; // Will be undefined for 'find-letter' game

                // The checkAnswer function will handle the rest
                checkAnswer(selectedCard, selectedLetter, correctLetter, exampleName);
            }

            function handleFindLetterClick(item, targetLetter, onCorrect) {
                if (item.classList.contains('found')) return;

                if (item.dataset.letter === targetLetter) {
                    playTone(880, 150, 'triangle'); // Correct "ding"
                    item.classList.add('found');
                    onCorrect();
                } else {
                    playTone(220, 200, 'square'); // Incorrect "buzz"
                    item.classList.add('incorrect');
                    setTimeout(() => item.classList.remove('incorrect'), 500);
                }
            }
            
            function checkAnswer(selectedCard, selectedLetter, correctLetter, exampleName) {
                // Disable clicking on other options
                const allCards = exerciseOptions.querySelectorAll('.exercise-card');
                allCards.forEach(c => c.style.pointerEvents = 'none');

                const isFindLetterGame = !exampleName;
                // For the 'find-letter' game, we need a case-sensitive check.
                // For other games, a case-insensitive check is fine.
                const isCorrect = isFindLetterGame ? (selectedLetter === correctLetter) : (selectedLetter.toLowerCase() === correctLetter.toLowerCase());

                if (isCorrect) {
                    const feedback = exampleName ? `${letterData.sound} for ${exampleName}!` : 'Correct!';
                    playSound(feedback, 1);
                    selectedCard.classList.add('correct');

                    if (isFindLetterGame) {
                        findLetterCorrectCount++;
                        if (findLetterCorrectCount >= 5) {
                            celebrate();
                            exerciseTitle.textContent = "You found them all!";
                            nextExerciseButton.textContent = "Start Over";
                            nextExerciseButton.classList.remove('hidden');
                        } else {
                            setTimeout(() => generateFindLetterExercise(), 1500);
                        }
                    } else { // sound-match game
                        soundMatchCorrectCount++;
                        if (soundMatchCorrectCount >= soundMatchGoal) {
                            // Game won!
                            celebrate();
                            exerciseTitle.textContent = "Great job! You matched them all!";
                            nextExerciseButton.textContent = "Start Over";
                            nextExerciseButton.classList.remove('hidden');
                        } else {
                            // Go to the next question
                            setTimeout(() => generateSingleSoundMatch(), 1500);
                        }
                    }
                } else {
                    findLetterCorrectCount = 0; // Reset counter on incorrect answer
                    playSound('Try again', 1);
                    selectedCard.classList.add('incorrect');
                    // Highlight the correct answer
                    allCards.forEach(c => {
                        if (isFindLetterGame ? (c.dataset.letter === correctLetter) : (c.dataset.letter.toLowerCase() === correctLetter.toLowerCase())) {
                            c.classList.add('correct');
                        }
                    });
                    // After an incorrect answer, automatically load the next question after a delay
                    setTimeout(() => generateExercise(activeGame), 2000);
                }
            }

            function celebrate() {
                confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
                const appContainer = document.getElementById('app-container');
                appContainer.style.animation = 'flash 1s ease-in-out';
                setTimeout(() => {
                    appContainer.style.animation = '';
                }, 1000);
            }

            // Letter Hunt Game Functions
            function resetHuntGame() {
                huntBoard.innerHTML = '<p class="text-gray-500 text-xl">Select a mode to start the game!</p>';
                huntCompleteMessage.classList.add('hidden');
                // Reset class for practice game board
                exerciseOptions.className = 'grid grid-cols-2 sm:grid-cols-4 gap-4 max-w-xl mx-auto';
                findCapitalsBtn.classList.remove('bg-blue-700');
                findLowersBtn.classList.remove('bg-blue-700');
                huntMode = null;
            }

            function startHuntGame(mode) {
                huntMode = mode;

                if (mode === 'capital') {
                    playSound("Find the Capital letters");
                } else {
                    playSound("Find the small letters");
                }

                huntCompleteMessage.classList.add('hidden');
                
                findCapitalsBtn.classList.toggle('bg-blue-700', mode === 'capital');
                findLowersBtn.classList.toggle('bg-blue-700', mode === 'lower');

                // Use setTimeout to allow the UI to update before heavy calculation
                // This also ensures the board is rendered before we get its dimensions.
                setTimeout(() => generateHuntBoard(mode), 50); // A small delay is safer
            }

            function generateHuntBoard(mode) {
                const lettersToHunt = []; 
                const totalLetters = 30;
                const targetLetter = mode === 'capital' ? 'A' : 'a';
                const otherLetter = mode === 'capital' ? 'a' : 'A';
                targetCount = 0;

                for (let i = 0; i < totalLetters; i++) {
                    if (Math.random() > 0.4) {
                        lettersToHunt.push(targetLetter);
                        targetCount++;
                    } else {
                        lettersToHunt.push(otherLetter);
                    }
                }

                // Shuffle
                lettersToHunt.sort(() => Math.random() - 0.5);

                huntBoard.innerHTML = '';
                const fragment = document.createDocumentFragment();

                // --- Grid-based positioning to prevent freezing ---
                const cols = 6; // 6 columns
                const rows = 5; // 5 rows
                const boardRect = huntBoard.getBoundingClientRect(); // Measure the board *after* it's visible
                const cellWidth = boardRect.width / cols;
                const cellHeight = boardRect.height / rows;
                let gridPositions = [];
                for(let i = 0; i < cols * rows; i++) {
                    gridPositions.push(i);
                }
                gridPositions.sort(() => Math.random() - 0.5); // Shuffle grid positions
                // --- End of new positioning logic ---

                for (const letter of lettersToHunt) {
                    const item = document.createElement('div');
                    item.textContent = letter;
                    item.className = 'letter-hunt-item text-5xl font-bold flex items-center justify-center';
                    item.dataset.letter = letter;
                    
                    // Place item in a random grid cell
                    const gridIndex = gridPositions.pop();
                    const col = gridIndex % cols;
                    const row = Math.floor(gridIndex / cols);
                    
                    // Add a little randomness within the cell
                    const left = col * cellWidth + (Math.random() * cellWidth * 0.1);
                    const top = row * cellHeight + (Math.random() * cellHeight * 0.1);
                    item.style.left = `${left}px`;
                    item.style.top = `${top}px`;

                    // Add some visual variety
                    const colors = ['text-blue-500', 'text-green-500', 'text-purple-500', 'text-orange-500', 'text-pink-500'];
                    item.classList.add(colors[Math.floor(Math.random() * colors.length)]);
                    item.style.transform = `rotate(${Math.random() * 40 - 20}deg) scale(${Math.random() * 0.4 + 0.8})`;

                    fragment.appendChild(item);
                }
                huntBoard.appendChild(fragment);
                huntBoard.addEventListener('click', handleHuntClick);
            }

            function handleHuntClick(e) {
                const clickedItem = e.target.closest('.letter-hunt-item');
                if (!clickedItem) return; // Ignore clicks on the board background

                if (clickedItem.classList.contains('found')) return;

                const clickedLetter = clickedItem.dataset.letter;
                const targetLetter = huntMode === 'capital' ? 'A' : 'a';

                if (clickedLetter === targetLetter) {
                    playTone(880, 150, 'triangle'); // Correct "ding" sound
                    clickedItem.classList.add('found', 'correct');
                    targetCount--;
                    if (targetCount === 0) {
                        gameWon();
                    }
                } else {
                    playTone(220, 200, 'square'); // Incorrect "buzz" sound
                    clickedItem.classList.add('incorrect');
                    setTimeout(() => clickedItem.classList.remove('incorrect'), 500);
                }
            }

            function gameWon() {
                playSound('You did it!', 1);
                huntCompleteMessage.innerHTML = `<p class="text-2xl font-bold text-green-600">You found them all!</p><button id="play-again-btn" class="nav-button mt-4 bg-blue-500 hover:bg-blue-600 text-white font-bold py-2 px-6 rounded-full">Play Again</button>`;
                huntCompleteMessage.classList.remove('hidden');
                huntBoard.removeEventListener('click', handleHuntClick); // Clean up listener
                document.getElementById('play-again-btn').addEventListener('click', () => startHuntGame(huntMode));
                celebrate();
            }

            // Initial call
            // We need to wait for voices to load for better speech synthesis
            if (synth.getVoices().length === 0) {
                synth.onvoiceschanged = initialize;
            } else {
                initialize();
            }

        });
    </script>

</body>
</html>
